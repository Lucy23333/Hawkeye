<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¹°çœ¼å®‰é˜²</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0a0a; --card: #141414; --text: #e0e0e0; --accent: #00f3ff; --danger: #ff2a6d; --nav: #1a1a1a; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .view-container { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; padding-bottom: 80px; }
        .view { display: none; padding: 20px; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        .header { padding: 20px 20px 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(10,10,10,0.95); position: sticky; top: 0; z-index: 50; backdrop-filter: blur(10px); border-bottom: 1px solid #222; }
        .header h1 { margin: 0; font-size: 20px; letter-spacing: 1px; font-weight: bold; }
        .status-badge { font-size: 10px; background: rgba(0, 243, 255, 0.1); color: var(--accent); padding: 4px 8px; border-radius: 10px; border: 1px solid var(--accent); }
        .device-card { background: var(--card); border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid #333; position: relative; cursor: pointer; transition: transform 0.1s; }
        .device-card:active { transform: scale(0.98); }
        .device-preview { height: 200px; background: #000; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .device-preview img { width: 100%; height: 100%; object-fit: cover; } 
        .device-tag { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-family: 'Fira Code'; color: #fff; border: 1px solid #444; }
        .live-badge { position: absolute; top: 10px; right: 10px; background: var(--danger); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; animation: blink 1s infinite; }
        .del-device-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255, 42, 109, 0.8); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 10; border: 1px solid #fff; }
        .device-info { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .device-name { font-weight: bold; font-size: 16px; color: #fff; }
        .device-status { font-size: 12px; color: #00ff88; display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 5px #00ff88; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .stat-num { font-size: 24px; font-weight: bold; color: var(--accent); font-family: 'Fira Code'; }
        .stat-tit { font-size: 12px; color: #888; margin-top: 5px; }
        .event-item { background: var(--card); border-radius: 12px; padding: 10px; display: flex; gap: 10px; border-left: 3px solid var(--accent); margin-bottom: 10px; position: relative; } 
        .event-img { width: 80px; height: 60px; border-radius: 8px; object-fit: cover; background: #111; }
        .event-txt { flex: 1; font-size: 12px; color: #ccc; line-height: 1.4; }
        .event-time { font-size: 10px; color: #666; margin-top: 5px; font-family: 'Fira Code'; }
        .btn-ai { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 2px 8px; font-size: 10px; border-radius: 4px; margin-top: 5px; cursor: pointer; }
        .btn-del-event { position: absolute; right: 10px; top: 10px; color: #666; cursor: pointer; font-size: 16px; }
        .profile-header { display: flex; align-items: center; gap: 20px; padding: 20px 0; border-bottom: 1px solid #222; margin-bottom: 20px; }
        .avatar-container { position: relative; cursor: pointer; }
        .avatar { width: 80px; height: 80px; background: #222; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); box-shadow: 0 0 15px rgba(0,243,255,0.2); }
        .menu-item { background: var(--card); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border: 1px solid #222; cursor: pointer; margin-bottom: 10px; }
        .bottom-nav { height: 60px; background: var(--nav); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; position: fixed; bottom: 0; width: 100%; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 10px; gap: 4px; cursor: pointer; flex: 1; padding: 5px 0; }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: none; animation: zoomIn 0.2s; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,243,255,0.15); border: 1px solid var(--accent); color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 12px; z-index: 300; backdrop-filter: blur(5px); display: none; box-shadow: 0 0 15px rgba(0,243,255,0.2); }
        .settings-form { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #888; font-size: 12px; margin-bottom: 8px; }
        .form-input { width: 100%; background: #222; border: 1px solid #444; padding: 12px; color: #fff; border-radius: 6px; box-sizing: border-box; font-family: 'Fira Code'; font-size: 12px; outline: none; }
        .btn-save { width: 100%; padding: 15px; background: var(--accent); border: none; color: #000; font-weight: bold; border-radius: 8px; margin-top: 20px; cursor: pointer; }
        .overlay-header { padding: 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333; background: #111; }
        #chart { width: 100%; height: 200px; margin-bottom: 20px; background: rgba(20, 30, 40, 0.5); border: 1px solid #333; border-radius: 12px; display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="toast" class="toast">âœ… æ“ä½œæˆåŠŸ</div>
    <input type="file" id="avatarInput" style="display: none" accept="image/*" onchange="handleAvatarUpload(this)">

    <div class="header">
        <h1>é¹°çœ¼å®‰é˜² <span style="font-size:12px;color:#666">v1.0</span></h1>
        <div class="status-badge">â— è§†é¢‘æµåœ¨çº¿</div>
    </div>

<div class="view-container">
    <div id="view-home" class="view active">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div style="font-size:12px;color:#888">å®æ—¶ç›‘æ§ç”»é¢</div>
            <div style="font-size:12px;color:var(--accent);cursor:pointer" onclick="window.open('/camera?id=CAM-NEW','_blank')">+ æ–°çª—å£æ‰“å¼€HUD</div>
        </div>
        <div id="device-container" class="device-list">
            <div style="padding:40px;text-align:center;color:#666">æ­£åœ¨æ‰«æè®¾å¤‡ç½‘ç»œ...</div>
        </div>
        <div style="text-align:center;padding:20px;color:#333;font-size:12px;border:1px dashed #333;border-radius:10px;margin-top:20px;cursor:pointer" onclick="promptNewDevice()">
            + æ‰‹åŠ¨æ·»åŠ è®¾å¤‡ (æ¨¡æ‹Ÿæ¥å…¥)
        </div>
    </div>

    <div id="view-dash" class="view">
        <div class="stat-grid">
            <div class="stat-box"><div class="stat-num" id="total-count">0</div><div class="stat-tit">ç´¯è®¡å‘Šè­¦</div></div>
            <div class="stat-box"><div class="stat-num" id="device-count" style="color:#00ff88">0</div><div class="stat-tit">åœ¨çº¿è®¾å¤‡</div></div>
        </div>
        <div id="chart"></div>
        <div style="font-size:12px;color:#888;margin-bottom:10px">å…¨ç½‘å®æ—¶å‘Šè­¦</div>
        <div id="event-list" class="event-list"></div>
    </div>

    <div id="view-me" class="view">
        <div class="profile-header">
            <div class="avatar-container" onclick="document.getElementById('avatarInput').click()">
                <img src="/uploads/avatars/Chihaya_Anon.jpg" class="avatar" id="user-avatar" style="object-fit: cover;">
                
                <div class="avatar-edit-icon">Ciallo!</div> 
            </div>
            <div class="user-info">
                <h2 id="disp-username">Chihaya_Anon</h2>
                <p>ID: 89757 â€¢ åƒæ—©çˆ±éŸ³</p>
            </div>
        </div>

        <div class="menu-list">
            <div class="menu-item" onclick="openProfileEdit()"><span>ğŸ‘¤ ä¿®æ”¹è´¦æˆ·ä¿¡æ¯</span> <span>></span></div>
            <div class="menu-item" onclick="openSettings()"><span>âš™ï¸ ç³»ç»Ÿå‚æ•°é…ç½®</span> <span>></span></div>
            <div class="menu-item" style="margin-top:20px;color:var(--danger);border-color:var(--danger)" onclick="location.href='/logout'"><span>ğŸšª é€€å‡ºç™»å½•</span></div>
        </div>
    </div> </div>

    <div class="bottom-nav">
        <div class="nav-btn active" id="nav-home" onclick="switchTab('home')"><span class="nav-icon">ğŸ“·</span><span>è®¾å¤‡</span></div>
        <div class="nav-btn" id="nav-dash" onclick="switchTab('dash')"><span class="nav-icon">ğŸ“Š</span><span>æ€åŠ¿</span></div>
        <div class="nav-btn" id="nav-me" onclick="switchTab('me')"><span class="nav-icon">ğŸ‘¤</span><span>æˆ‘çš„</span></div>
    </div>

    <div id="hud-overlay" class="overlay-full">
        <div class="close-hud" onclick="closeHUD()" style="position:absolute;top:30px;left:20px;z-index:210;color:#fff;padding:8px 15px;background:rgba(0,0,0,0.6);border-radius:20px;font-size:14px;pointer-events:auto">â† è¿”å›</div>
        <iframe id="hud-frame" src="" allow="camera; microphone" style="width:100%;height:100%;border:none"></iframe>
    </div>

    <div id="settings-overlay" class="overlay-full" style="background:var(--bg)"><div class="overlay-header"><div class="back-btn" onclick="closeSettings()">â†</div><div style="font-weight:bold">ç³»ç»Ÿé…ç½®</div></div><div class="settings-form"><form onsubmit="event.preventDefault(); saveConfig()"><div class="form-group"><label class="form-label">AI Endpoint</label><input id="s-ep" class="form-input" value="{{.AIEndpoint}}"></div><div class="form-group"><label class="form-label">AI Key</label><input id="s-key" type="password" class="form-input" value="{{.AIKey}}"></div><div class="form-group"><label class="form-label">Model</label><input id="s-model" class="form-input" value="{{.AIModel}}"></div><button class="btn-save">ä¿å­˜é…ç½®</button></form></div></div>
    <div id="profile-overlay" class="overlay-full" style="background:var(--bg)"><div class="overlay-header"><div class="back-btn" onclick="closeProfileEdit()">â†</div><div style="font-weight:bold">è´¦æˆ·ä¿¡æ¯</div></div><div class="settings-form"><form onsubmit="event.preventDefault(); saveProfile()"><div class="form-group"><label class="form-label">Username</label><input id="p-user" class="form-input" value="{{.AdminUser}}"></div><div class="form-group"><label class="form-label">New Password</label><input id="p-pass" type="password" class="form-input"></div><button class="btn-save">æ›´æ–°è´¦æˆ·</button></form></div></div>

    <script>
        window.onload = function() { switchTab(localStorage.getItem('lastTab') || 'home', false); fetchDevices(); };
        
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; t.style.animation = 'fadeIn 0.3s';
            setTimeout(() => { t.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => { t.style.display = 'none'; }, 300); }, 2000);
        }
        function switchTab(tabName, animate = true) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active');
            document.getElementById('nav-' + tabName).classList.add('active');
            localStorage.setItem('lastTab', tabName);
            if(tabName === 'home') fetchDevices();
            
            // ğŸ”¥ FIXED: Init chart when switching to Dashboard
            if(tabName === 'dash') {
                fetchEvents();
                if(!chartInstance) initChart(); // Lazy Init
                setTimeout(() => { if(chartInstance) chartInstance.resize(); }, 200);
            }
        }
        function openHUD(deviceId) { 
            document.getElementById('hud-frame').src = '/camera?id=' + deviceId; 
            document.getElementById('hud-overlay').style.display = 'block'; 
        }
        function closeHUD() { document.getElementById('hud-overlay').style.display = 'none'; document.getElementById('hud-frame').src = ''; }
        function openSettings() { document.getElementById('settings-overlay').style.display = 'block'; }
        function closeSettings() { document.getElementById('settings-overlay').style.display = 'none'; }
        function openProfileEdit() { document.getElementById('profile-overlay').style.display = 'block'; }
        function closeProfileEdit() { document.getElementById('profile-overlay').style.display = 'none'; }
        
        function promptNewDevice() {
            const id = prompt("è¯·è¾“å…¥æ–°è®¾å¤‡ ID (å¦‚ CAM-02):", "CAM-" + Math.floor(Math.random()*100));
            if(id) window.location.href = '/camera?id=' + id;
        }

        function deleteDevice(deviceId, event) {
            event.stopPropagation();
            if(confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤è®¾å¤‡ [' + deviceId + '] åŠå…¶æ‰€æœ‰å†å²æ•°æ®ï¼\nç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                fetch('/delete_device?device_id=' + deviceId, {method: 'POST'})
                .then(() => { showToast('ğŸ—‘ï¸ è®¾å¤‡å·²åˆ é™¤'); fetchDevices(); fetchEvents(); });
            }
        }

        function deleteEvent(filename) {
            if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡å‘Šè­¦è®°å½•å—ï¼Ÿ')) {
                fetch('/delete?filename=' + filename, {method: 'POST'})
                .then(() => { showToast('ğŸ—‘ï¸ è®°å½•å·²åˆ é™¤'); fetchEvents(); });
            }
        }

        function fetchDevices() {
            fetch('/api/devices').then(r=>r.json()).then(d => {
                const container = document.getElementById('device-container');
                document.getElementById('device-count').innerText = d.length;
                if(d.length === 0) {
                    container.innerHTML = '<div style="padding:20px;text-align:center;color:#666;border:1px dashed #444;border-radius:10px">æš‚æ— è®¾å¤‡åœ¨çº¿<br>è¯·å¯åŠ¨ Edge å®¢æˆ·ç«¯</div>';
                    return;
                }
                container.innerHTML = d.map(dev => 
                    '<div class="device-card" onclick="openHUD(\''+dev.id+'\')">' +
                        '<div class="del-device-btn" onclick="deleteDevice(\''+dev.id+'\', event)">âœ•</div>' +
                        '<div class="device-preview">' +
                            '<div class="live-badge">LIVE</div>' +
                            '<img src="/api/stream?device_id='+dev.id+'" onerror="this.style.display=\'none\'">' +
                            '<div class="device-tag">'+dev.id+'</div>' +
                        '</div>' +
                        '<div class="device-info">' +
                            '<div><div class="device-name">'+dev.id+'</div><div style="font-size:10px;color:#666">Stream Active</div></div>' +
                            '<div class="device-status"><div class="dot"></div> è§†é¢‘æµä¼ è¾“ä¸­</div>' +
                        '</div>' +
                    '</div>'
                ).join('');
            });
        }

        function fetchEvents() {
            fetch('/api/events').then(r=>r.json()).then(d => {
                document.getElementById('total-count').innerText = d.count;
                const list = document.getElementById('event-list');
                list.innerHTML = (d.events || []).map(e => 
                    '<div class="event-item">' +
                        '<div class="btn-del-event" onclick="deleteEvent(\''+e.Filename+'\')">ğŸ—‘ï¸</div>' +
                        '<a href="/uploads/'+e.Filename+'" target="_blank"><img src="/uploads/'+e.Filename+'" class="event-img" loading="lazy"></a>' +
                        '<div class="event-txt">' +
                            '<div style="color:var(--accent);font-weight:bold;margin-bottom:4px">âš ï¸ '+e.DeviceID+'</div>' +
                            '<div>'+(e.AIAnalysis ? e.AIAnalysis : '<span style="color:#666">åˆ†æä¸­...</span>')+'</div>' +
                            '<div class="event-time">'+e.CaptureTime+'</div>' +
                            (!e.AIAnalysis ? '<button class="btn-ai" onclick="analyze(\''+e.Filename+'\')">âš¡ åˆ†æ</button>' : '') +
                        '</div>' +
                    '</div>'
                ).join('');
            });
        }
        
        function handleAvatarUpload(input) { if (input.files && input.files[0]) { const fd = new FormData(); fd.append('avatar', input.files[0]); showToast('ğŸ“¤ ä¸Šä¼ ä¸­...'); fetch('/api/upload_avatar', { method: 'POST', body: fd }).then(r => r.json()).then(data => { if(data.status === 'ok') { showToast('âœ… æˆåŠŸ'); const img = document.getElementById('user-avatar'); if(img.tagName==='DIV') location.reload(); else img.src=data.url+'?t='+new Date().getTime(); } }); } }
        function saveProfile() { const u=document.getElementById('p-user').value, p=document.getElementById('p-pass').value; fetch('/api/update_profile',{method:'POST',body:JSON.stringify({username:u,password:p})}).then(()=>{showToast('âœ… å·²æ›´æ–°');document.getElementById('disp-username').innerText=u;setTimeout(closeProfileEdit,500)}); }
        function saveConfig() { const d={ai_endpoint:document.getElementById('s-ep').value,ai_key:document.getElementById('s-key').value,ai_model:document.getElementById('s-model').value,admin_user:"{{.AdminUser}}"}; fetch('/settings',{method:'POST',body:JSON.stringify(d)}).then(()=>{showToast('âœ… å·²ä¿å­˜');setTimeout(closeSettings,500)}); }
        function analyze(f) { showToast('ğŸ”„ AI åˆ†æä¸­...'); fetch('/analyze?filename='+f).then(()=>{ showToast('âœ… å®Œæˆ'); fetchEvents(); }); }

        let chartInstance;
        function initChart() {
            const chartDom = document.getElementById('chart');
            if(chartDom) {
                chartInstance = echarts.init(chartDom, 'dark', {renderer: 'canvas'});
                chartInstance.setOption({
                    backgroundColor: 'transparent',
                    grid: {top:20,bottom:20,left:30,right:10},
                    tooltip: {trigger: 'axis'},
                    xAxis: {type:'category', data:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], axisLine:{lineStyle:{color:'#333'}}}, 
                    yAxis: {type:'value', splitLine:{lineStyle:{color:'#222'}}}, 
                    series: [{
                        data:[3, 1, 5, 2, 8, 4, 1], 
                        type:'line', 
                        smooth:true, 
                        areaStyle:{opacity:0.2, color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: '#00f3ff'}, {offset: 1, color: 'rgba(0, 243, 255, 0)'}])},
                        itemStyle:{color: '#00f3ff'},
                        lineStyle:{width: 3}
                    }]
                });
            }
        }
        
        window.addEventListener('resize', () => { if(chartInstance) chartInstance.resize(); });

        setInterval(fetchEvents, 4000);
        setInterval(fetchDevices, 5000);
    </script>
</body>
</html>